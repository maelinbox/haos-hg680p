name: Build HAOS HG680P

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y util-linux parted gzip tar

      - name: Download Armbian & HAOS image
        run: |
          wget -O armbian.img.gz https://github.com/ophub/amlogic-s9xxx-armbian/releases/download/Armbian_bullseye_save_2025.08/Armbian_25.08.0_amlogic_s905x_bullseye_6.1.147_server_2025.08.01.img.gz
          wget -O haos.img.xz https://github.com/home-assistant/operating-system/releases/download/16.1/haos_generic-aarch64-16.1.img.xz
          gunzip armbian.img.gz
          unxz haos.img.xz

      - name: Mount partitions & copy kernel/dtb
        run: |
          mkdir -p armbian_boot armbian_root haos_boot haos_root

          # Cari offset boot & root Armbian
          BOOT_OFFSET=$(parted -s armbian.img unit s print | awk '/boot/ {print $2}' | sed 's/s//')
          ROOT_OFFSET=$(parted -s armbian.img unit s print | awk '/root/ {print $2}' | sed 's/s//')
          # Cari offset boot & root HAOS
          H_BOOT_OFFSET=$(parted -s haos.img unit s print | awk '/boot/ {print $2}' | sed 's/s//')
          H_ROOT_OFFSET=$(parted -s haos.img unit s print | awk '/hassos-data/ {print $2}' | sed 's/s//')

          # Mount Armbian
          sudo mount -o loop,offset=$((512*BOOT_OFFSET)) armbian.img armbian_boot
          sudo mount -o loop,offset=$((512*ROOT_OFFSET)) armbian.img armbian_root

          # Mount HAOS
          sudo mount -o loop,offset=$((512*H_BOOT_OFFSET)) haos.img haos_boot
          sudo mount -o loop,offset=$((512*H_ROOT_OFFSET)) haos.img haos_root

          # Salin kernel & dtb
          sudo cp -v armbian_boot/uImage haos_boot/ || true
          sudo cp -v armbian_boot/*.dtb haos_boot/dtb/ || true

          # Unmount semua
          sudo umount armbian_boot || true
          sudo umount armbian_root || true
          sudo umount haos_boot || true
          sudo umount haos_root || true

      - name: Upload patched HAOS
        uses: actions/upload-artifact@v4
        with:
          name: haos-hg680p
          path: haos.img
